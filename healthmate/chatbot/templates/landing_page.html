<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthMate - Chatbot</title>
    {% load static %}
    <link rel="stylesheet" href="{% static '/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>
</head>
<body>
    <!-- Container to hold chat and additional info -->
    <div class="main-grid-container">
        <!-- Chatbox Section -->
        <div class="chat-container">
            <div class="chat-header">
                <h1>Welcome to HealthMate</h1>
            </div>

            <div id="chat-box" class="chat-box">
                <!-- Loading spinner -->
                <div id="loading-spinner" class="spinner" style="display:none;"></div>
            </div>

            <form id="chat-form" class="chat-form">
                <input type="text" id="user-message" placeholder="Ask something about your health..." required>
                <button type="submit">Send</button>
            </form>
        </div>

        <!-- Sidebar for additional information -->
        <div id="additional-info-sidebar" class="additional-info-sidebar">
            <div class="sidebar-header">
                <h2>Additional Information</h2>
            </div>
            <div id="additional-info-content" class="sidebar-content"></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('chat-form');
        const chatBox = document.getElementById('chat-box');
        const spinner = document.getElementById('loading-spinner');
        const additionalInfoSidebar = document.getElementById('additional-info-sidebar');
        const additionalInfoContent = document.getElementById('additional-info-content');
    
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = document.getElementById('user-message').value;
    
            // Add user's message to chat
            addMessageToChat('user', message);
    
            // Show loading spinner
            spinner.style.display = 'block';
    
            // Send the message to the backend
            try {
                const response = await fetch('', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({ message, patient_email: 'john.doe@example.com' })  // Include patient_email in request
                });
    
                if (!response.ok) {
                    throw new Error('Server error or failed response');  // Handle non-200 responses
                }
    
                const data = await response.json();
    
                // Hide loading spinner
                spinner.style.display = 'none';
    
                // Check if bot response exists and is not empty
                // if (data.response) {
                //     // Add bot's message to chat only if it's not empty or null
                addMessageToChat('bot', data.response);
                // } else {
                //     console.warn('Empty or null bot response received, not displaying any message.');
                // }
    
                // Display additional information if present
                if (data.additional_info) {
                    showAdditionalInfo(data.additional_info);
                }
            } catch (error) {
                console.error('Error during fetch operation:', error);
                spinner.style.display = 'none';  // Hide spinner in case of error
                alert('There was an issue communicating with the server. Please try again later.');
            }
        });
    
        function addMessageToChat(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message');
    
            // Get the current time
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
            // Create a new instance of the showdown converter
            const converter = new showdown.Converter();
    
            // Convert the message from Markdown to HTML
            const htmlMessage = converter.makeHtml(message);
    
            // Set innerHTML to render HTML properly
            const content = `
                <div>${htmlMessage}</div>
                <span class="timestamp">${time}</span>
            `;
    
            messageElement.innerHTML = content;  // Use innerHTML to render the converted HTML
    
            if (sender === 'user') {
                messageElement.classList.add('user-message');
            } else {
                messageElement.classList.add('bot-message');
            }
    
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;  // Auto scroll to the bottom
            document.getElementById('user-message').value = '';  // Clear input field
        }
    
        function showAdditionalInfo(info) {
            // Display additional information in the sidebar
            additionalInfoContent.innerHTML = `<p>${info}</p>`;
            additionalInfoSidebar.style.display = 'block';
        }
    </script>
    

</body>
</html>
